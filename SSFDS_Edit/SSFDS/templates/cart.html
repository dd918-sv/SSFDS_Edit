{% extends 'layout.html' %}
{% block content %}
<div class="container">
    <h1 class="my-4">My Orders</h1>
    <div class="card mb-3">
        <div class="card-body">
            {% for order in orders %}
            <div class="row" id="order-{{ order.id }}">
                <div class="col-md-4">
                    <h5 class="card-title">{{ order.dish.name }}</h5>
                    <p class="card-text text-muted">Description: {{ order.dish.description }}</p>
                </div>
                <div class="col-md-4">
                    <form id="remove-form-{{ order.id }}" method="POST" action="{{ url_for('remove_order', order_id=order.id) }}">
                        <div class="form-group">
                            <label for="quantity-{{ order.id }}">Quantity:</label>
                            <input type="number" id="quantity-{{ order.id }}" name="quantity" class="form-control quantity-input" value="{{ order.quantity }}" min="1" onchange="updatePrice('{{ order.id }}','{{order.dish.price}}')">
                        </div>
                        <button type="button" class="btn btn-danger" onclick="removeOrder('{{ order.id }}')">Remove</button>
                    </form>
                </div>
                <div class="col-md-4">
                    <p id="price-{{ order.id }}" class="card-text"><strong>Price:</strong> Rs{{ order.dish.price * order.quantity }}</p>
                </div>
            </div>
            <br><br>
            {% endfor %}
            <div class="row">
                <div class="col-md-12">
                    <div class="form-check">
                        <input class="form-check-input" type="checkbox" id="selfPickupCheckbox" onclick="toggleDeliveryCharges()">
                        <label class="form-check-label" for="selfPickupCheckbox">Self Pickup</label>
                    </div>
                </div>
            </div>
            <div class="row" id="deliveryChargesDiv" style="display:block;">
                <div class="col-md-12">
                    <div class="alert alert-info" role="alert">
                        Delivery Charge: Rs<span id="deliveryCharge">{{ delivery_charge }}</span>
                    </div>
                </div>
            </div>
            <button type="button" class="btn btn-primary" onclick="placeOrder()">Place Order</button>
        </div>
    </div>
</div>

<script>
    function removeOrder(orderId) {
        if (confirm("Are you sure you want to remove this order?")) {
            document.getElementById("remove-form-" + orderId).submit();
        }
    }

    function updatePrice(orderId, price) {
        var quantity = parseInt(document.getElementById("quantity-" + orderId).value);
        var pricePerUnit = price;  // Assuming all dishes have the same price
        var totalPrice = quantity * pricePerUnit;
        document.getElementById("price-" + orderId).innerHTML = "<strong>Price:</strong> Rs" + totalPrice.toFixed(2);
    }

    function toggleDeliveryCharges() {
        var selfPickupCheckbox = document.getElementById("selfPickupCheckbox");
        var deliveryChargesDiv = document.getElementById("deliveryChargesDiv");
        if (selfPickupCheckbox.checked) {
            deliveryChargesDiv.style.display = "none";
        } else {
            deliveryChargesDiv.style.display = "block";
        }
    }

    function placeOrder() {
        var orders = [];
        var quantityInputs = document.querySelectorAll('.quantity-input');
        quantityInputs.forEach(function(input) {
            var orderId = input.id.split("-")[1];
            var quantity = parseInt(input.value);
            orders.push({ "dish_id": orderId, "quantity": quantity });
        });

        var paymentMethod = "Cash";  // Default payment method
        var selfPickupCheckbox = document.getElementById("selfPickupCheckbox");
        if (selfPickupCheckbox.checked) {
            paymentMethod = "Prepaid";
        }

        $.ajax({
            url: '/place_order',
            type: 'POST',
            contentType: 'application/json',
            data: JSON.stringify({ "orders": orders, "payment_method": paymentMethod }),
            success: function(response) {
                if (response.success) {
                    alert("Order placed successfully!");
                    window.location.href = '/home'; // Redirect to home page
                } else {
                    alert("Failed to place order. Please try again.");
                }
            },
            error: function(xhr, status, error) {
                console.error(xhr.responseText);
            }
        });
    }
</script>

{% endblock %}
